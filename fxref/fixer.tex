
\documentclass[12pt,a4paper]{article}
\usepackage{luacode}
\usepackage[yyyymmdd]{datetime}

\thispagestyle{empty}
\renewcommand{\dateseparator}{-}

\begin{luacode*}
  local cjson = require "lunajson"
  local http = require "socket.http"
  local hrequest = http.request
  local currency = require "currency"
  local gsub = string.gsub
  print = tex.print
  
  function fixer (date, base)
     local base = base or "EUR"
     local r, c, h = hrequest("http://api.fixer.io/"..date.."?base="..base)
     if not r or c ~= 200 then
        return nil, c
     end
     return cjson.decode(r)
  end

  function country (a, nocur)
     local nocur = nocur or false
     local con = currency[a] or a
     if nocur then
        con = gsub(con, "(.+)%s%a+$", "%1")
     end
     return con
  end
\end{luacode*}


\begin{document}

%%% 
\def\date{\today}
\def\code{\luastring{EUR}}
%%%
\def\country#1{\luaexec{print(country(#1))}}

\renewcommand{\arraystretch}{1.2}

\begin{center}
  {\Large \country{\code, true} Foreign Exchange Refernce Rates}\\
  \medskip
  \date\\
  \bigskip
  \begin{tabular}{ l l r }
    \hline
    \textbf{\sffamily ISO 4217 code} & \textbf{\sffamily Currency}
    & \textbf{\sffamily Spot}\\
    \hline
    \luaexec{
      local fx = fixer(\luastring{\date}, \code)
      for k, v in pairs(fx.rates) do
         print("{\\sffamily "..k.."} & "..country(k).." & "..v.."\\\\")
      end
    }
    \hline
  \end{tabular}
\end{center}
\end{document}

